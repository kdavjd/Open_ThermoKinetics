# Model-Based Notebook Enhancement - Feature Specification

> **Дата создания:** 2026-02-14
> **Дата завершения:** 2026-02-14
> **Ветка:** `feature/model-based-notebook`
> **Статус:** ✅ Завершён
> **Коммит:** e58ea61

---

## Workflow выполнения

Данное ТЗ должно выполняться согласно **генеральному workflow** из [CLAUDE.md](../../CLAUDE.md).

### Тип workflow: Новая фича

### Порядок выполнения

| Шаг | Действие            | Навык                                  | Статус     |
| --- | ------------------- | -------------------------------------- | ---------- |
| а   | Создание ТЗ + Ветка | —                                      | ✅ Завершён |
| б   | Реализация          | `spec-implementer`                     | ✅ Завершён |
| в   | Тестирование        | `gui-testing`                          | ✅ Завершён |
| г   | Мерж                | `merge-helper`                         | ✅ Завершён |

### Текущий статус и следующий шаг

**Текущий шаг:** б (Реализация) — ✅ Завершён
- Все 6 этапов реализации завершены

**Следующий шаг:** в (Тестирование)
- Выполнить через навык `gui-testing`: `/gui-testing`

---

## Видение

Ноутбук `docs/ru/3_model_based.ipynb` с полной теорией model-based метода и интерактивными ячейками для отладки и оптимизации производительности расчётов.

**Ключевые требования:**
- Теория всех разделов model-based метода (LaTeX формулы)
- Повторение реального расчёта из логов (NH4_parse_TGA.csv, A→B→C→D)
- Метрики производительности (время, память, итерации)
- Полная визуализация (модель vs эксперимент, концентрации, residuals)

---

## План реализации

### Этап 1: Теоретические ячейки (~150 строк)
**Статус:** ✅ Завершён

**Цель:** Добавить markdown-ячейки с теорией model-based метода по аналогии с 1_model_fit.ipynb и 2_model_free.ipynb.

**Задачи:**
- [x] Добавить раздел "Концентрация vs конверсия" (e = 1 - α)
- [x] Добавить раздел "Уравнение Аррениуса" (k = A·exp(-Ea/RT))
- [x] Добавить раздел "ОДУ система для многостадийных реакций"
- [x] Добавить раздел "Метод интеграции BDF" (stiff systems)
- [x] Добавить раздел "Оптимизация differential_evolution"
- [x] Добавить раздел "Master-графики y(α), z(α)"

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — вставить markdown cells перед кодом)

**Критерий приёмки:**
- Все 6 разделов теории присутствуют
- LaTeX формулы корректно рендерятся
- Стиль соответствует 1_model_fit.ipynb и 2_model_free.ipynb

---

### Этап 2: Загрузка данных и схема реакций (~40 строк)
**Статус:** ✅ Завершён

**Цель:** Подготовить code-ячейку с загрузкой реальных данных из логов.

**Задачи:**
- [x] Загрузить NH4_parse_TGA.csv (temperature, rate_3, rate_5, rate_10)
- [x] Определить схему реакций A → B → C → D
- [x] Задать параметры из логов: logA, Ea, model, contributions
- [x] Нормализовать массы (experimental_masses = [1, 1, 1])

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — добавить code cell после теории)

**Критерий приёмки:**
- Данные загружаются без ошибок
- Параметры соответствуют логам (все реакции одинаковые):
  - logA=8.0, Ea=120.0 kJ/mol, contribution=0.5, model=F2
- Границы оптимизации заданы корректно:
  - Ea ∈ [30, 250] кДж/моль
  - logA ∈ [-15, 30]
  - contribution ∈ [0.01, 1]
  - allowed_models = ['A2/3', 'A3', 'A3/2', 'F1/3', 'F1/A1', 'F2', 'F3', 'G1', 'G2', 'R2', 'R3']

---

### Этап 3: Функция ОДУ интеграции (~80 строк)
**Статус:** ✅ Завершён

**Цель:** Реализовать ОДУ функцию как в src/core/model_based_calculation.py с 50ms timeout.

**Задачи:**
- [x] Реализовать ode_function() по аналогии с model_based_calculation.py
- [x] Реализовать integrate_ode_for_beta() с timeout декоратором
- [x] Добавить обработку ошибок TimeoutError
- [x] Использовать BDF метод для stiff систем

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — добавить code cell)

**Критерий приёмки:**
- ОДУ интеграция работает для всех β = 3, 5, 10
- Timeout 50ms на одно интегрирование
- Используется метод BDF (не RK45)

---

### Этап 4: Оптимизация differential_evolution (~60 строк)
**Статус:** ✅ Завершён

**Цель:** Реализовать оптимизацию с метриками производительности.

**Задачи:**
- [x] Реализовать objective_function для DE
- [x] Настроить differential_evolution с параметрами из логов:
  - strategy='best1bin', maxiter=1000, popsize=50, tol=0.01
  - workers=6, init='latinhypercube'
- [x] Добавить timeout 2 минуты для всего расчёта
- [x] Добавить обработку не сходящейся оптимизации

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — добавить code cell)

**Критерий приёмки:**
- Оптимизация запускается и сходится
- Timeout работает корректно
- Результаты близки к логам (MSE < 0.01)

---

### Этап 5: Визуализация результатов (~100 строк)
**Статус:** ✅ Завершён

**Цель:** Добавить ячейки для визуализации результатов расчёта.

**Задачи:**
- [x] График "Модель vs эксперимент" (все β на одном графике)
- [x] График концентраций A, B, C, D по температуре
- [x] График residuals (ошибки модели)
- [x] График сравнения результатов для разных β

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — добавить code cells)

**Критерий приёмки:**
- Все 4 графика отображаются корректно
- Экспериментальные точки видны на графике модели
- Residuals показывают качество подгонки

---

### Этап 6: Профилирование производительности (~50 строк)
**Статус:** ✅ Завершён

**Цель:** Добавить ячейки для измерения производительности.

**Задачи:**
- [x] Измерение времени выполнения всего расчёта
- [x] Измерение потребления памяти (memory profiling)
- [x] Подсчёт итераций DE (actual vs maxiter)
- [x] Подсчёт вызовов ОДУ функции

**Файлы:**
- `docs/ru/3_model_based.ipynb` (modify — добавить code cells)

**Критерий приёмки:**
- Время выполнения выводится в секундах
- Потребление памяти выводится в MB
- Число итераций и вызовов ОДУ корректно

---

## Параметры расчёта (из логов)

```python
# Схема реакций (все реакции с одинаковыми начальными параметрами)
scheme = {
    "components": [{"id": "A"}, {"id": "B"}, {"id": "C"}, {"id": "D"}],
    "reactions": [
        {
            "from": "A", "to": "B",
            "reaction_type": "F2",
            "Ea": 120.0, "log_A": 8.0, "contribution": 0.5,
            "Ea_min": 30.0, "Ea_max": 200.0,
            "log_A_min": -15.0, "log_A_max": 30.0,
            "contribution_min": 0.01, "contribution_max": 1.0,
            "allowed_models": ["A2/3", "A3", "A3/2", "F1/3", "F1/A1", "F2", "F3", "F3/2", "F3/4", "G1", "G2", "R2", "R3"]
        },
        {
            "from": "B", "to": "C",
            "reaction_type": "F2",
            "Ea": 120.0, "log_A": 8.0, "contribution": 0.5,
            "Ea_min": 30.0, "Ea_max": 250.0,
            "log_A_min": -15.0, "log_A_max": 30.0,
            "contribution_min": 0.01, "contribution_max": 1.0,
            "allowed_models": ["A2/3", "A3", "A3/2", "F1/3", "F1/A1", "F2", "F3", "G1", "G2", "R2", "R3"]
        },
        {
            "from": "C", "to": "D",
            "reaction_type": "F2",
            "Ea": 120.0, "log_A": 8.0, "contribution": 0.5,
            "Ea_min": 30.0, "Ea_max": 250.0,
            "log_A_min": -15.0, "log_A_max": 30.0,
            "contribution_min": 0.01, "contribution_max": 1.0,
            "allowed_models": ["A2/3", "A3", "A3/2", "F1/3", "F1/A1", "F2", "F3", "G1", "G2", "R2", "R3"]
        }
    ]
}

# Параметры DE
de_params = {
    "strategy": "best1bin",
    "maxiter": 1000,
    "popsize": 50,
    "tol": 0.01,
    "mutation": (0.4, 1.2),
    "recombination": 0.7,
    "init": "latinhypercube",
    "workers": 6,
    "polish": False
}

# Данные
betas = [3.0, 5.0, 10.0]
experimental_masses = [1, 1, 1]
csv_path = "resources/NH4_parse_TGA.csv"
```

---

## История изменений

| Дата       | Этап | Коммит | Описание                    |
| ---------- | ---- | ------ | --------------------------- |
| 2026-02-14 | -    | -      | ТЗ создано                  |
| 2026-02-14 | 1    | -      | Добавлены теоретические markdown-ячейки (6 разделов) |
| 2026-02-14 | 2    | -      | Добавлена загрузка данных и схема реакций (параметры из логов) |
| 2026-02-14 | 3    | -      | Реализованы ОДУ функции с BDF и timeout 50ms |
| 2026-02-14 | 4    | -      | Реализована оптимизация differential_evolution с DE параметрами |
| 2026-02-14 | 5    | -      | Добавлена визуализация: модель vs эксперимент, концентрации, residuals, сравнение β |
| 2026-02-14 | 6    | -      | Добавлено профилирование: время, память, итерации DE, вызовы ОДУ |
| 2026-02-14 | MERGE | -      | Feature merged to main |
